<html>
  <div id="test">

  </div>
</html>
<script type="module">
  import * as GF from './dist/index.js'

  let xhr = new XMLHttpRequest()

  const peelTree = function(t) {
    let a = t.args
    if (a.length) {
      return (a[0])
    }
  };

  function getPred(tree) {
    // console.log("getPred.tree", tree)
    if (["Passive", "Active"].includes(tree.name)) {
        console.log("getPred", tree, tree.args[0])
        return tree.args[0]
    } else {
        return tree
        console.log("Expecting an argument of NoEvidenceThat, got", tree);
    }
  }

  function mergeRedundant(trees) {
    const tree1 = trees[0]
    const tree2 = trees[1]
      // console.log("mergeRedundant:", tree1, tree2)
      if (getPred(tree1) === getPred(tree2)) {
          return tree1;
      } else {
          return { name: "BecauseS", args: [tree1, tree2] };
      }
  }

  function skipRedundantActive(trees) {
    const tree1 = trees[0]
    const tree2 = trees[0]
    if (tree1.name === "NoEvidenceThat" && tree2.name === "NoEvidenceThat") {
      return mergeRedundant([peelTree(tree1), peelTree(tree2)]);
    } else {
      throw new Error("Expecting trees that start with NoEvidenceThat");
    }
  }

  function printTest(txt) {
    document.getElementById("test").innerHTML = txt;
  }

  xhr.open('GET', 'School.json')
  xhr.onload = function () {
    if (xhr.status === 200) {
      let json = JSON.parse(xhr.responseText)
      let grammar = GF.fromJSON(json)
      console.log(grammar)
      let s = ["condition (NoEvidenceThat (Passive (MeetCriterion (MassNP (UseN _foreign_student_N)))))", "condition (NoEvidenceThat (Active (MeetCriterion (MassNP (UseN _foreign_student_N))) (UsePron s_he_Pron)))", "fullStop (NoEvidenceThat (EmbedSC (UsePron s_he_Pron) (MkVPS presSimul POS (UseComp (CompNP (DetCN aSg (AdjCN (PositA _foreign_A) (UseN _student_N))))))))"]
      let trees = s.map(x => grammar.abstract.parseTree(x, "S"))
      console.log("trees:")
      trees.map(x => console.log("   ", x.print()))
      console.log("linearised:")
      trees.map(x => console.log("   ", grammar.concretes.SchoolEng.linearize(x)))


      let peeled = trees.map(x => (peelTree(x)))
      console.log("peeled:", peeled.map(x => x.print()))

      let skip = skipRedundantActive(peeled)
      console.log("skip:", JSON.stringify(skip), skip.print()) // JSON.stringify(skip))

      let redundant = mergeRedundant(peeled)
      console.log(redundant.toString())
      console.log(redundant.name, redundant.args)
      console.log("redundant", JSON.stringify(redundant))


      let tests =
        "mergeRedundant <p>" + JSON.stringify(redundant) + "<p>" + grammar.concretes.SchoolEng.linearize((redundant)) +
        "<p> skipRedundantActive <p>" + JSON.stringify(skip) + "<p>" + grammar.concretes.SchoolEng.linearize((skip))

      printTest(tests)


    }
  }


  xhr.send()
</script>
